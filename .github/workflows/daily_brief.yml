name: Daily Alpha Briefing

on:
  schedule:
    # HKT 4:44 AM = UTC 20:44 (Previous Day)
    - cron: "44 20 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sense-and-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Engine (Public)
        uses: actions/checkout@v4

      - name: Checkout Data (Private)
        uses: actions/checkout@v4
        with:
          repository: wonwoo0/investsense-data
          token: ${{ secrets.PAT_TOKEN }}
          path: data

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Set up Python
        run: uv python install 3.12

      - name: Install Dependencies
        run: uv sync

      - name: Run Search 2.1 Pipeline
        env:
          SAM_GOV_API_KEY: ${{ secrets.SAM_GOV_API_KEY }}
          USER_AGENT_EMAIL: ${{ secrets.USER_AGENT_EMAIL }}
          REDDIT_USERNAME: ${{ secrets.REDDIT_USERNAME }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          PYTHONPATH: .
        run: |
          # 1. Gather (Scouts)
          uv run -m src.scout_hunter
          uv run -m src.scout_social
          uv run -m src.scout_gov
          # Legacy Scouts (Optional)
          # uv run -m src.scout_shield 
          # uv run -m src.scout_labor

          # 2. Filter (Gatekeeper)
          uv run -m src.scout_gatekeeper

          # 3. React (Librarian)
          uv run -m src.scout_librarian

          # 3.5 Process Hot Pursuit Results (Gatekeeper Pass 2)
          uv run -m src.scout_gatekeeper

          # 4. Reason (Brain)
          uv run -m src.brain_reasoning

          # 5. Archive (Cleanup)
          uv run -m src.utils.archiver

      - name: Check for Changes and Push Data
        working-directory: data
        run: |
          git config user.name "Kazuha Bot"
          git config user.email "bot@investsense.ai"

          # 檢查有無新 missions 或者新報告
          git add .  # 呢度會包埋 active_missions.yml
          if [[ -n $(git status -s) ]]; then
            git commit -m "Capture daily alpha and update missions [skip ci]"
            git push
          else
            echo "No changes detected."
          fi

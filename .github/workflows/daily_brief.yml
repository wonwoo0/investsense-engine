name: Daily Alpha Briefing

on:
  schedule:
    # 7:00 AM HKT (23:00 UTC prev day) and 9:00 PM HKT (13:00 UTC)
    - cron: "0 23 * * *" 
    - cron: "0 13 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sense-and-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Engine (Public)
        uses: actions/checkout@v4

      - name: Checkout Data (Private)
        uses: actions/checkout@v4
        with:
          repository: wonwoo0/investsense-data
          token: ${{ secrets.PAT_TOKEN }}
          path: data

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Set up Python
        run: uv python install 3.12

      - name: Install Dependencies
        run: uv sync

      - name: Run Senses (Data Collection)
        env:
          SAM_GOV_API_KEY: ${{ secrets.SAM_GOV_API_KEY }}
          USER_AGENT_EMAIL: ${{ secrets.USER_AGENT_EMAIL }}
          REDDIT_USERNAME: ${{ secrets.REDDIT_USERNAME }}
        run: |
          uv run -m src.scout_gov
          uv run -m src.scout_social
          uv run -m src.scout_feed
          uv run -m src.scout_shield
          uv run -m src.scout_hunter
          uv run -m src.scout_labor

      - name: Semantic Deduplication & Consolidation
        run: uv run -m src.scout_dedup

      - name: Run Brain (Reasoning & Report)
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          uv run -m src.brain_reasoning

      - name: Check for Changes and Push Data
        working-directory: data
        run: |
          git config user.name "Kazuha Bot"
          git config user.email "bot@investsense.ai"

          # Check if there are changes
          if [[ -n $(git status -s) ]]; then
            echo "Changes detected. Committing..."
            git add .
            git commit -m "Auto-update: Daily Alpha Briefing [skip ci]"
            git push
          else
            echo "No changes to data."
          fi
